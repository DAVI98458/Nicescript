--==================================================
-- LOAD RAYFIELD
--==================================================
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

--==================================================
-- FUNÇÃO PRINCIPAL
--==================================================
local function RunAutoGuardScript()
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    local RunService = game:GetService("RunService")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local switchCamsEvent

    local Animatronics, rightDoorPrompt, leftDoorPrompt, chairPrompt

    --== LOOP ATÉ ENCONTRAR TODOS OS PATHS
    repeat
        Animatronics = {
            Foxy   = workspace.Animatronics:FindFirstChild("Foxy") and workspace.Animatronics.Foxy:FindFirstChild("FoxyNPC"),
            Freddy = workspace.Animatronics:FindFirstChild("Freddy") and workspace.Animatronics.Freddy:FindFirstChild("FreddyNPC"),
            Chica  = workspace.Animatronics:FindFirstChild("Chica") and workspace.Animatronics.Chica:FindFirstChild("ChicaNPC"),
            Bonnie = workspace.Animatronics:FindFirstChild("Bonnie") and workspace.Animatronics.Bonnie:FindFirstChild("BonnieNPC")
        }

        rightDoorPrompt = workspace.GameTriggers:FindFirstChild("OfficeButtons") 
                        and workspace.GameTriggers.OfficeButtons:FindFirstChild("RightDoorButton")
                        and workspace.GameTriggers.OfficeButtons.RightDoorButton.Part:FindFirstChild("ProximityPrompt")

        leftDoorPrompt = workspace.GameTriggers:FindFirstChild("OfficeButtons") 
                        and workspace.GameTriggers.OfficeButtons:FindFirstChild("LeftDoorButton")
                        and workspace.GameTriggers.OfficeButtons.LeftDoorButton.Part:FindFirstChild("ProximityPrompt")

        chairPrompt = workspace.GameTriggers:FindFirstChild("OfficeChair") 
                        and workspace.GameTriggers.OfficeChair:FindFirstChild("ProxPart")
                        and workspace.GameTriggers.OfficeChair.ProxPart:FindFirstChild("ProximityPrompt")

        switchCamsEvent = ReplicatedStorage:FindFirstChild("RemoteEvents") 
                        and ReplicatedStorage.RemoteEvents:FindFirstChild("playerSwitchCamsEvent")

        local allFound = true
        for _, anim in pairs(Animatronics) do
            if not anim then allFound = false break end
        end
        if not rightDoorPrompt or not leftDoorPrompt or not chairPrompt or not switchCamsEvent then
            allFound = false
        end

        if not allFound then
            wait(0.5)
        end
    until Animatronics.Foxy and Animatronics.Freddy and Animatronics.Chica and Animatronics.Bonnie and rightDoorPrompt and leftDoorPrompt and chairPrompt and switchCamsEvent

    --==================================================
    -- CONFIG
    --==================================================
    local DETECTION_RADIUS = 17
    local CLOSE_DELAY = 1.5
    local CAM_SWITCH_INTERVAL = 2.5
    local AutoGuardEnabled = false
    local HighlightEnabled = false
    local ChairPromptFired = false

    local Prompts = {rightDoorPrompt, leftDoorPrompt}
    local PromptState = {}
    for _, prompt in ipairs(Prompts) do
        PromptState[prompt] = {Count = 0, Active = false, Timer = 0, FoxyDetected = false}
    end

    --==================================================
    -- GUI
    --==================================================
    local Window = Rayfield:CreateWindow({
        Name = "FNAF 1 Co-op",
        LoadingTitle = "FNAF 1 Co-op",
        LoadingSubtitle = "By: shadown_gd",
        ConfigurationSaving = { Enabled = false }
    })

    local MainTab = Window:CreateTab("Main")

    MainTab:CreateToggle({
        Name = "Auto Guard",
        CurrentValue = false,
        Flag = "AutoGuardToggle",
        Callback = function(value)
            AutoGuardEnabled = value
            if AutoGuardEnabled and not ChairPromptFired then
                ChairPromptFired = true
                fireproximityprompt(chairPrompt)
            end
        end
    })

    MainTab:CreateToggle({
        Name = "Highlight Animatronics",
        CurrentValue = false,
        Flag = "HighlightToggle",
        Callback = function(value)
            HighlightEnabled = value
            if value then
                for _, anim in pairs(Animatronics) do
                    if anim and not anim:FindFirstChildOfClass("Highlight") then
                        local h = Instance.new("Highlight")
                        h.FillColor = Color3.fromRGB(255,0,0)
                        h.OutlineColor = Color3.fromRGB(255,255,255)
                        h.Parent = anim
                    end
                end
            else
                for _, anim in pairs(Animatronics) do
                    for _, h in ipairs(anim:GetChildren()) do
                        if h:IsA("Highlight") then
                            h:Destroy()
                        end
                    end
                end
            end
        end
    })

    --==================================================
    -- FUNÇÃO CENTRAL DO MODELO
    --==================================================
    local function getModelCenter(model)
        local total = Vector3.zero
        local count = 0
        for _, obj in ipairs(model:GetDescendants()) do
            if obj:IsA("BasePart") then
                total += obj.Position
                count += 1
            end
        end
        if count == 0 then return nil end
        return total / count
    end

    --==================================================
    -- LOOP DE SWITCH DE CÂMERAS (COROUTINE)
    --==================================================
    spawn(function()
        local camToggle = true
        while true do
            if AutoGuardEnabled then
                if camToggle then
                    switchCamsEvent:FireServer("CAM1A")
                else
                    switchCamsEvent:FireServer("")
                end
                camToggle = not camToggle
            end
            wait(CAM_SWITCH_INTERVAL)
        end
    end)

    --==================================================
    -- LOOP PRINCIPAL DE DETECÇÃO E PORTAS
    --==================================================
    RunService.Heartbeat:Connect(function(dt)
        if not AutoGuardEnabled then return end

        -- reset counts e flags
        for _, state in pairs(PromptState) do
            state.Count = 0
            state.FoxyDetected = false
        end

        -- detectar animatronics
        for name, anim in pairs(Animatronics) do
            if anim and anim:IsDescendantOf(workspace) then
                local pos = getModelCenter(anim)
                if pos then
                    local closestPrompt = nil
                    local closestDist = DETECTION_RADIUS
                    for _, prompt in ipairs(Prompts) do
                        local dist = (pos - prompt.Parent.Position).Magnitude
                        if dist <= closestDist then
                            closestDist = dist
                            closestPrompt = prompt
                        end
                    end
                    if closestPrompt then
                        local state = PromptState[closestPrompt]
                        state.Count += 1
                        if name == "Foxy" then
                            state.FoxyDetected = true
                        end
                    end
                end
            end
        end

        -- lógica de portas
        for promptObj, state in pairs(PromptState) do
            if state.Count > 0 then
                if state.FoxyDetected and not state.Active then
                    state.Active = true
                    state.Timer = 0
                    fireproximityprompt(promptObj)
                elseif not state.FoxyDetected then
                    state.Timer += dt
                    if state.Timer >= CLOSE_DELAY and not state.Active then
                        state.Active = true
                        fireproximityprompt(promptObj)
                    end
                end
            else
                state.Timer = 0
                state.FoxyDetected = false
                if state.Active then
                    state.Active = false
                    fireproximityprompt(promptObj)
                end
            end
        end
    end)
end

--==================================================
-- EXECUTA SCRIPT
--==================================================
RunAutoGuardScript()
